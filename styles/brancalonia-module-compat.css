/* ================================================ */
/* BRANCALONIA MODULE COMPATIBILITY                */
/* Support for third-party Foundry modules         */
/* ================================================ */

@layer module {
  /* ================================================
     DICE SO NICE INTEGRATION
     ================================================ */

  .theme-brancalonia .dice-so-nice-settings {
    background: var(--bcl-surface-primary);
  }

  .theme-brancalonia .dice-preview {
    background: var(--bcl-surface-secondary);
    border: 2px solid var(--bcl-gold);
    border-radius: var(--bcl-radius-md);
  }

  /* ================================================
     TOKEN ACTION HUD
     ================================================ */

  .theme-brancalonia .token-action-hud {
    background: var(--bcl-surface-elevated);
    border: 1px solid var(--bcl-gold);
    border-radius: var(--bcl-radius-md);
    box-shadow: var(--bcl-shadow-xl);
  }

  .theme-brancalonia .token-action-hud .tah-action {
    background: var(--bcl-surface-primary);
    border: 1px solid var(--bcl-border);
    border-radius: var(--bcl-radius-sm);
    color: var(--bcl-text-primary);
    font-family: var(--bcl-font-serif);
    transition: all var(--bcl-transition-fast);
  }

  .theme-brancalonia .token-action-hud .tah-action:hover {
    background: var(--bcl-interactive-normal);
    color: var(--bcl-text-inverse);
    transform: translateY(-1px);
  }

  /* ================================================
     ORCNOG CARD VIEWER - Safe integration
     ================================================ */

  .theme-brancalonia .orcnog-card-viewer {
    color: var(--bcl-text-primary);
    background: var(--bcl-surface-primary);
  }

  .theme-brancalonia .orcnog-card-viewer .ocv-toolbar,
  .theme-brancalonia .orcnog-card-viewer .ocv-panel {
    background: var(--bcl-surface-secondary);
    border: 1px solid var(--bcl-border);
    box-shadow: var(--bcl-shadow-md);
    border-radius: var(--bcl-radius-sm);
  }

  .theme-brancalonia .orcnog-card-viewer .ocv-button {
    background: transparent;
    border: 1px solid var(--bcl-border);
    border-radius: var(--bcl-radius-sm);
    padding: var(--bcl-space-2) var(--bcl-space-3);
    color: var(--bcl-text-primary);
    transition: all var(--bcl-transition-fast);
  }

  .theme-brancalonia .orcnog-card-viewer .ocv-button:hover {
    background: var(--bcl-gold);
    color: var(--bcl-text-inverse);
    border-color: var(--bcl-gold);
    transform: translateY(-1px);
  }

  .theme-brancalonia .orcnog-card-viewer .ocv-card {
    background: var(--bcl-surface-primary);
    box-shadow: var(--bcl-shadow-lg);
    border: 1px solid var(--bcl-divider);
    border-radius: var(--bcl-radius-md);
  }

  /* ================================================
     MIDI-QOL
     ================================================ */

  .theme-brancalonia .midi-qol-attack-roll,
  .theme-brancalonia .midi-qol-damage-roll {
    background: var(--bcl-surface-secondary);
    border: 1px solid var(--bcl-gold);
    border-radius: var(--bcl-radius-md);
    padding: var(--bcl-space-2);
  }

  .theme-brancalonia .midi-qol-target-name {
    font-family: var(--bcl-font-display);
    font-weight: var(--bcl-font-weight-bold);
    color: var(--bcl-interactive-normal);
  }

  .theme-brancalonia .midi-qol-target-grid {
    background: var(--bcl-surface-primary);
    border: 1px solid var(--bcl-divider);
    border-radius: var(--bcl-radius-sm);
  }

  /* ================================================
     TIDY5E SHEETS
     ================================================ */

  .theme-brancalonia .tidy5e.sheet {
    background: var(--bcl-surface-primary);
  }

  .theme-brancalonia .tidy5e.sheet .window-content {
    background: var(--bcl-surface-primary);
    color: var(--bcl-text-primary);
  }

  .theme-brancalonia .tidy5e.sheet .sheet-header {
    background: linear-gradient(135deg,
      var(--bcl-surface-tertiary) 0%,
      var(--bcl-surface-secondary) 100%);
    border-bottom: 3px solid var(--bcl-gold);
  }

  .theme-brancalonia .tidy5e.sheet .sheet-tab {
    background: var(--bcl-surface-secondary);
    border: 1px solid var(--bcl-border);
    color: var(--bcl-text-secondary);
    font-family: var(--bcl-font-serif);
  }

  .theme-brancalonia .tidy5e.sheet .sheet-tab.active {
    background: var(--bcl-surface-primary);
    color: var(--bcl-gold);
    border-bottom-color: var(--bcl-surface-primary);
  }

  .theme-brancalonia .tidy5e.sheet .items-list {
    background: var(--bcl-surface-secondary);
    border: 1px solid var(--bcl-border);
    border-radius: var(--bcl-radius-md);
  }

  .theme-brancalonia .tidy5e.sheet .item {
    border-bottom: 1px solid var(--bcl-divider);
  }

  .theme-brancalonia .tidy5e.sheet .item:hover {
    background: var(--bcl-surface-tertiary);
  }

  /* Tidy5e Dark Mode override */
  .theme-brancalonia .tidy5e.dark-mode {
    --t5e-primary-color: var(--bcl-gold);
    --t5e-secondary-color: var(--bcl-interactive-normal);
    --t5e-tertiary-color: var(--bcl-accent);
    --t5e-background-color: var(--bcl-surface-primary);
    --t5e-faint-color: var(--bcl-surface-secondary);
    --t5e-light-color: var(--bcl-surface-tertiary);
    --t5e-text-color: var(--bcl-text-primary);
    --t5e-text-light-color: var(--bcl-text-secondary);
  }

  /* ================================================
     MONARCH
     ================================================ */

  .theme-brancalonia .monarch-sheet {
    background: var(--bcl-surface-primary);
    --monarch-color-primary: var(--bcl-gold);
    --monarch-color-secondary: var(--bcl-interactive-normal);
    --monarch-color-border: var(--bcl-border);
    --monarch-color-bg: var(--bcl-surface-primary);
    --monarch-color-bg-light: var(--bcl-surface-secondary);
    --monarch-color-text: var(--bcl-text-primary);
  }

  .theme-brancalonia .monarch-sheet .sheet-header {
    background: linear-gradient(135deg,
      var(--bcl-surface-tertiary) 0%,
      var(--bcl-surface-secondary) 100%);
    border-bottom: 2px solid var(--bcl-gold);
  }

  /* ================================================
     COMBAT TRACKER ENHANCEMENTS
     ================================================ */

  .theme-brancalonia #combat #combat-tracker {
    background: var(--bcl-surface-primary);
  }

  .theme-brancalonia #combat .combatant {
    background: var(--bcl-surface-secondary);
    border: 1px solid var(--bcl-divider);
    border-radius: var(--bcl-radius-sm);
    margin-bottom: var(--bcl-space-1);
  }

  .theme-brancalonia #combat .combatant.active {
    background: linear-gradient(90deg,
      var(--bcl-gold) 0%,
      var(--bcl-interactive-hover) 100%);
    box-shadow: var(--bcl-shadow-gold);
  }

  .theme-brancalonia #combat .combatant .token-name {
    font-family: var(--bcl-font-serif);
    font-weight: var(--bcl-font-weight-semibold);
    color: var(--bcl-text-primary);
  }

  .theme-brancalonia #combat .combatant .initiative {
    font-family: var(--bcl-font-display);
    font-size: var(--bcl-font-size-lg);
    font-weight: var(--bcl-font-weight-bold);
    color: var(--bcl-interactive-normal);
  }

  /* ================================================
     POLYGLOT
     ================================================ */

  .theme-brancalonia .polyglot-lang-select {
    background: var(--bcl-surface-elevated);
    border: 1px solid var(--bcl-gold);
    border-radius: var(--bcl-radius-sm);
    color: var(--bcl-text-primary);
    font-family: var(--bcl-font-serif);
  }

  .theme-brancalonia .message .polyglot-message-language {
    background: var(--bcl-surface-tertiary);
    border: 1px solid var(--bcl-divider);
    border-radius: var(--bcl-radius-sm);
    padding: var(--bcl-space-1) var(--bcl-space-2);
    font-family: var(--bcl-font-script);
    color: var(--bcl-text-secondary);
    font-style: italic;
  }

  /* ================================================
     ITEM PILES
     ================================================ */

  .theme-brancalonia .item-pile-app {
    background: var(--bcl-surface-primary);
  }

  .theme-brancalonia .item-pile-app .item-pile-header {
    background: linear-gradient(135deg,
      var(--bcl-surface-sunken) 0%,
      var(--bcl-surface-tertiary) 100%);
    border-bottom: 2px solid var(--bcl-gold);
    padding: var(--bcl-space-3);
  }

  .theme-brancalonia .item-pile-app .item-pile-item {
    background: var(--bcl-surface-secondary);
    border: 1px solid var(--bcl-divider);
    border-radius: var(--bcl-radius-sm);
    margin: var(--bcl-space-1);
    padding: var(--bcl-space-2);
    transition: all var(--bcl-transition-fast);
  }

  .theme-brancalonia .item-pile-app .item-pile-item:hover {
    background: var(--bcl-surface-tertiary);
    transform: translateX(4px);
  }

  /* ================================================
     MONK'S TOKEN BAR
     ================================================ */

  .theme-brancalonia .monks-tokenbar {
    background: var(--bcl-surface-elevated);
    border: 2px solid var(--bcl-gold);
    border-radius: var(--bcl-radius-lg);
    box-shadow: var(--bcl-shadow-xl);
  }

  .theme-brancalonia .monks-tokenbar .token {
    border: 2px solid var(--bcl-border);
    border-radius: var(--bcl-radius-md);
    transition: all var(--bcl-transition-fast);
  }

  .theme-brancalonia .monks-tokenbar .token:hover {
    border-color: var(--bcl-gold);
    transform: scale(1.1);
    box-shadow: var(--bcl-shadow-gold);
  }

  .theme-brancalonia .monks-tokenbar .token.selected {
    border-color: var(--bcl-interactive-hover);
    box-shadow: 0 0 8px var(--bcl-gold);
  }

  /* ================================================
     SIMPLE CALENDAR
     ================================================ */

  .theme-brancalonia .simple-calendar {
    background: var(--bcl-surface-primary);
    --sc-primary: var(--bcl-gold);
    --sc-secondary: var(--bcl-interactive-normal);
    --sc-background: var(--bcl-surface-primary);
    --sc-background-secondary: var(--bcl-surface-secondary);
    --sc-text: var(--bcl-text-primary);
    --sc-text-secondary: var(--bcl-text-secondary);
    --sc-border: var(--bcl-border);
  }

  .theme-brancalonia .simple-calendar .calendar-header {
    background: linear-gradient(135deg,
      var(--bcl-surface-tertiary) 0%,
      var(--bcl-surface-secondary) 100%);
    border-bottom: 2px solid var(--bcl-gold);
  }

  .theme-brancalonia .simple-calendar .calendar-day {
    background: var(--bcl-surface-secondary);
    border: 1px solid var(--bcl-divider);
    transition: all var(--bcl-transition-fast);
  }

  .theme-brancalonia .simple-calendar .calendar-day:hover {
    background: var(--bcl-surface-tertiary);
    border-color: var(--bcl-gold);
  }

  .theme-brancalonia .simple-calendar .calendar-day.selected {
    background: var(--bcl-interactive-normal);
    color: var(--bcl-text-inverse);
  }

  /* ================================================
     FORIEN'S QUEST LOG
     ================================================ */

  .theme-brancalonia .forien-quest-log {
    background: var(--bcl-surface-primary);
  }

  .theme-brancalonia .forien-quest-log .quest-log-header {
    background: linear-gradient(135deg,
      var(--bcl-surface-sunken) 0%,
      var(--bcl-surface-tertiary) 100%);
    border-bottom: 3px solid var(--bcl-gold);
    padding: var(--bcl-space-3);
  }

  .theme-brancalonia .forien-quest-log .quest-item {
    background: var(--bcl-surface-secondary);
    border: 1px solid var(--bcl-divider);
    border-radius: var(--bcl-radius-md);
    margin: var(--bcl-space-2);
    padding: var(--bcl-space-3);
  }

  .theme-brancalonia .forien-quest-log .quest-item.completed {
    background: linear-gradient(135deg,
      rgba(46, 125, 100, 0.1) 0%,
      var(--bcl-surface-secondary) 100%);
    border-color: var(--bcl-state-success);
  }

  .theme-brancalonia .forien-quest-log .quest-title {
    font-family: var(--bcl-font-display);
    font-weight: var(--bcl-font-weight-bold);
    color: var(--bcl-gold);
  }

  /* ================================================
     BETTER ROLLS FOR 5E
     ================================================ */

  .theme-brancalonia .better-rolls-5e {
    background: var(--bcl-surface-primary);
    border: 1px solid var(--bcl-gold);
    border-radius: var(--bcl-radius-md);
  }

  .theme-brancalonia .better-rolls-5e .roll-header {
    background: linear-gradient(90deg,
      var(--bcl-surface-sunken) 0%,
      var(--bcl-surface-tertiary) 100%);
    border-bottom: 2px solid var(--bcl-gold);
    padding: var(--bcl-space-2);
  }

  .theme-brancalonia .better-rolls-5e .roll-result {
    font-family: var(--bcl-font-display);
    font-size: var(--bcl-font-size-xl);
    font-weight: var(--bcl-font-weight-bold);
    color: var(--bcl-interactive-normal);
  }

  .theme-brancalonia .better-rolls-5e .roll-result.critical {
    color: var(--bcl-state-success);
    text-shadow: 0 0 8px var(--bcl-emerald);
    animation: bcl-pulse-gold 1s ease-in-out;
  }

  .theme-brancalonia .better-rolls-5e .roll-result.fumble {
    color: var(--bcl-state-danger);
    text-shadow: 0 0 8px var(--bcl-venetian-red);
  }

  /* ================================================
     CUSTOM DND5E
     ================================================ */

  .theme-brancalonia.custom-dnd5e {
    --custom-dnd5e-primary: var(--bcl-gold);
    --custom-dnd5e-secondary: var(--bcl-interactive-normal);
    --custom-dnd5e-tertiary: var(--bcl-accent);
    --custom-dnd5e-background: var(--bcl-surface-primary);
    --custom-dnd5e-surface: var(--bcl-surface-secondary);
    --custom-dnd5e-text: var(--bcl-text-primary);
    --custom-dnd5e-text-light: var(--bcl-text-secondary);
    --custom-dnd5e-border: var(--bcl-border);
  }

  /* ================================================
     ORCNOG UI (when detected)
     ================================================ */

  body.theme-brancalonia.orcnog-ui {
    --orcnog-primary: var(--bcl-gold);
    --orcnog-secondary: var(--bcl-interactive-normal);
    --orcnog-background: var(--bcl-surface-primary);
    --orcnog-surface: var(--bcl-surface-secondary);
    --orcnog-text: var(--bcl-text-primary);
  }

  /* Override Orcnog's aggressive styling */
  body.theme-brancalonia.orcnog-ui .window-app {
    background: var(--bcl-surface-primary) !important;
  }

  body.theme-brancalonia.orcnog-ui .window-header {
    background: linear-gradient(135deg,
      var(--bcl-surface-sunken) 0%,
      var(--bcl-surface-tertiary) 100%) !important;
  }

  /* ================================================
     CAROLINGIAN UI COMPATIBILITY
     ================================================ */

  body.theme-brancalonia[data-crlngn-theme] {
    /* Map Carolingian tokens to Brancalonia */
    --crlngn-color-primary: var(--bcl-gold);
    --crlngn-color-secondary: var(--bcl-interactive-normal);
    --crlngn-color-tertiary: var(--bcl-accent);
    --crlngn-color-background: var(--bcl-surface-primary);
    --crlngn-color-surface: var(--bcl-surface-secondary);
    --crlngn-color-text: var(--bcl-text-primary);
    --crlngn-color-text-secondary: var(--bcl-text-secondary);
    --crlngn-color-border: var(--bcl-border);
    --crlngn-color-divider: var(--bcl-divider);
  }

  /* ================================================
     DRAG RULER
     ================================================ */

  .theme-brancalonia .drag-ruler-label {
    background: var(--bcl-surface-elevated);
    border: 1px solid var(--bcl-gold);
    color: var(--bcl-text-primary);
    font-family: var(--bcl-font-serif);
    border-radius: var(--bcl-radius-sm);
    padding: var(--bcl-space-1) var(--bcl-space-2);
  }

  /* ================================================
     PF2E STYLE COMPAT (for multiverse games)
     ================================================ */

  .theme-brancalonia .pf2e-style {
    --pf2e-primary: var(--bcl-gold);
    --pf2e-secondary: var(--bcl-interactive-normal);
    --pf2e-tertiary: var(--bcl-accent);
  }

  /* ================================================
     PERFORMANCE OPTIMIZATIONS
     ================================================ */

  /* Reduce animations when many modules are active */
  body.theme-brancalonia.many-modules * {
    animation-duration: 0.1s !important;
    transition-duration: 0.1s !important;
  }

  /* GPU acceleration for module windows */
  .theme-brancalonia .module-window {
    transform: translateZ(0);
    will-change: transform;
  }
}